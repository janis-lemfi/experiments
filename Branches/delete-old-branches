#!/bin/bash

# gh output without pager
export GH_PAGER=

git fetch --prune

remote_branches=$(git for-each-ref \
	--sort=committerdate --format="%(committerdate:short) %(refname:short)" refs/remotes/ |
	grep -v HEAD |
	awk -v date="$(date -v-3m +%Y-%m-%d)" '$1 < date { print $2 }')

echo "Got remote branches older than 3 months"

for line in ${remote_branches}; do
	branch=$(echo "$line" | sed "s/origin\///")
	read -r protected date < <(
		gh api "repos/Newton-Capital/Lemonadefinance/branches/$branch" |
			jq '"\(.protected) \(.commit.commit.committer.date)"' |
			sed -e 's/\"//g' |
			sed -E 's/T.*//g'
	)

	if [[ "$protected" == "true" ]]; then
		# check if branch can still be deleted (one+ year old branches)
		can_delete=$(echo "$date" | awk -v date="$(date -v-1y +%Y-%m-%d)" '$1 < date { print("true"); }')
		if [[ "$can_delete" != "true" ]] || [[ "$branch" =~ ^(main|master|develop|dev)$ ]]; then
			# check if branch doesn't contain reserved words
			echo "Cannot delete protected branch: $branch"
			continue
		fi
	fi
	echo "Deleting branch: $branch"
	git push -d origin $(echo $branch)
done
